<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pusat Komando Bisnis Deo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; }
        .tab-button.active { border-color: #1d4ed8; color: #1d4ed8; background-color: #e0e7ff; }
        .modal-backdrop { background-color: rgba(0,0,0,0.6); }
        .card { background-color: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .table-header { background-color: #f9fafb; }
        .low-stock { background-color: #fef2f2 !important; color: #b91c1c; }
        #app-container.hidden, #auth-container.hidden, #loader.hidden, #config-error.hidden { display: none; }
    </style>
</head>
<body class="text-gray-800">

    <!-- Config Error -->
    <div id="config-error" class="hidden min-h-screen flex items-center justify-center bg-gray-100">
        <div class="card p-8 w-full max-w-lg text-center">
            <i class="fas fa-exclamation-triangle text-5xl text-red-500 mb-4"></i>
            <h2 class="text-2xl font-bold mb-4">Konfigurasi Firebase Belum Lengkap</h2>
            <p class="text-gray-600">
                Harap salin (copy) <code>firebaseConfig</code> dari Firebase Console Anda dan tempel (paste) di dalam kode file HTML ini untuk menggantikan placeholder.
            </p>
            <p class="text-sm mt-4 text-gray-500">
                Lihat kembali Bagian 1, Langkah 3 dari tutorial untuk instruksi lengkap.
            </p>
        </div>
    </div>

    <!-- Loader -->
    <div id="loader" class="fixed inset-0 bg-white flex items-center justify-center z-50">
        <i class="fas fa-spinner fa-spin text-4xl text-blue-600"></i>
    </div>

    <!-- Authentication -->
    <div id="auth-container" class="hidden min-h-screen flex items-center justify-center bg-gray-100">
        <div class="card p-8 w-full max-w-md">
            <div id="auth-content">
                <!-- Login Form -->
                <div id="login-form">
                    <h2 class="text-2xl font-bold text-center mb-6">Login</h2>
                    <form onsubmit="handleLogin(event)">
                        <div class="mb-4"><label class="block text-sm font-medium">Email</label><input type="email" id="login-email" class="mt-1 w-full p-2 border-gray-300 rounded-md" required></div>
                        <div class="mb-4"><label class="block text-sm font-medium">Password</label><input type="password" id="login-password" class="mt-1 w-full p-2 border-gray-300 rounded-md" required></div>
                        <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg font-semibold hover:bg-blue-700">Login</button>
                    </form>
                    <p class="text-center text-sm mt-4">Belum punya akun? <button onclick="toggleAuthForm('signup')" class="text-blue-600 font-semibold">Daftar</button></p>
                </div>
                <!-- Signup Form -->
                <div id="signup-form" class="hidden">
                    <h2 class="text-2xl font-bold text-center mb-6">Daftar Akun Baru</h2>
                    <form onsubmit="handleSignup(event)">
                        <div class="mb-4"><label class="block text-sm font-medium">Email</label><input type="email" id="signup-email" class="mt-1 w-full p-2 border-gray-300 rounded-md" required></div>
                        <div class="mb-4"><label class="block text-sm font-medium">Password</label><input type="password" id="signup-password" class="mt-1 w-full p-2 border-gray-300 rounded-md" required></div>
                        <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg font-semibold hover:bg-blue-700">Daftar</button>
                    </form>
                    <p class="text-center text-sm mt-4">Sudah punya akun? <button onclick="toggleAuthForm('login')" class="text-blue-600 font-semibold">Login</button></p>
                </div>
            </div>
            <p id="auth-error" class="text-red-500 text-center mt-4"></p>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="hidden">
        <div class="container mx-auto p-4 md:p-6 max-w-screen-2xl">
            <header class="flex justify-between items-center mb-6">
                <div>
                    <h1 id="business-name-header" class="text-3xl font-bold text-gray-800">Deo Business Suite</h1>
                    <p id="user-email-display" class="text-gray-500"></p>
                </div>
                <div class="flex items-center gap-4">
                     <div class="relative">
                        <input id="date-filter" class="bg-white border border-gray-300 rounded-lg py-2 px-4 w-64 cursor-pointer" placeholder="Filter Tanggal...">
                    </div>
                    <button onclick="openModal('modal-settings')" class="text-gray-500 hover:text-blue-600"><i class="fas fa-cog fa-lg"></i></button>
                    <button onclick="handleLogout()" class="text-gray-500 hover:text-red-600" title="Logout"><i class="fas fa-sign-out-alt fa-lg"></i></button>
                </div>
            </header>

            <!-- Tabs -->
            <div class="mb-6 border-b border-gray-200">
                <nav class="flex flex-wrap -mb-px" aria-label="Tabs">
                    <button onclick="changeTab('dashboard')" class="tab-button active flex items-center gap-2 whitespace-nowrap py-3 px-4 border-b-2 font-semibold text-sm"><i class="fas fa-chart-pie"></i>Dashboard</button>
                    <button onclick="changeTab('keuangan')" class="tab-button flex items-center gap-2 whitespace-nowrap py-3 px-4 border-b-2 font-semibold text-sm"><i class="fas fa-wallet"></i>Keuangan</button>
                    <button onclick="changeTab('produk')" class="tab-button flex items-center gap-2 whitespace-nowrap py-3 px-4 border-b-2 font-semibold text-sm"><i class="fas fa-box-open"></i>Produk</button>
                    <button onclick="changeTab('bahanBaku')" class="tab-button flex items-center gap-2 whitespace-nowrap py-3 px-4 border-b-2 font-semibold text-sm"><i class="fas fa-cubes"></i>Bahan Baku</button>
                    <button onclick="changeTab('transaksi')" class="tab-button flex items-center gap-2 whitespace-nowrap py-3 px-4 border-b-2 font-semibold text-sm"><i class="fas fa-exchange-alt"></i>Input Transaksi</button>
                    <button onclick="changeTab('analitik')" class="tab-button flex items-center gap-2 whitespace-nowrap py-3 px-4 border-b-2 font-semibold text-sm"><i class="fas fa-chart-line"></i>Analitik</button>
                    <button onclick="changeTab('laporan')" class="tab-button flex items-center gap-2 whitespace-nowrap py-3 px-4 border-b-2 font-semibold text-sm"><i class="fas fa-file-invoice-dollar"></i>Laporan</button>
                </nav>
            </div>

            <!-- Tab Content -->
            <main id="app-content">
                <!-- Dashboard -->
                <div id="dashboard" class="tab-content">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                        <div class="card p-5"><h3 class="text-sm font-medium text-gray-500">Total Saldo Kas</h3><p id="db-total-saldo" class="mt-1 text-3xl font-bold text-indigo-600">Rp 0</p></div>
                        <div class="card p-5"><h3 class="text-sm font-medium text-gray-500">Total Penjualan</h3><p id="db-total-penjualan" class="mt-1 text-3xl font-bold text-green-600">Rp 0</p></div>
                        <div class="card p-5"><h3 class="text-sm font-medium text-gray-500">Total Keuntungan</h3><p id="db-total-keuntungan" class="mt-1 text-3xl font-bold text-blue-600">Rp 0</p></div>
                        <div class="card p-5"><h3 class="text-sm font-medium text-gray-500">Total Pengeluaran</h3><p id="db-total-pengeluaran" class="mt-1 text-3xl font-bold text-red-600">Rp 0</p></div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                        <div class="lg:col-span-3 card p-5"><h3 class="font-semibold mb-4">Grafik Penjualan</h3><div class="relative h-80"><canvas id="salesChart"></canvas></div></div>
                        <div class="lg:col-span-2 card p-5"><h3 class="font-semibold mb-4">Penjualan per Varian</h3><div class="relative h-80"><canvas id="variantChart"></canvas></div></div>
                    </div>
                </div>

                <!-- Keuangan -->
                <div id="keuangan" class="tab-content hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 card p-6">
                            <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">Akun Kas</h3><button onclick="openModal('modal-akun-kas')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 font-semibold"><i class="fas fa-plus mr-2"></i>Tambah Akun</button></div>
                            <div id="list-akun-kas" class="space-y-4"></div>
                        </div>
                        <div class="card p-6">
                            <h3 class="text-xl font-bold mb-4">Transfer Dana</h3>
                            <form id="form-transfer">
                                <div class="mb-3"><label class="block text-sm font-medium">Dari Akun</label><select id="transfer-from" class="mt-1 block w-full p-2 border-gray-300 rounded-md" required></select></div>
                                <div class="mb-3"><label class="block text-sm font-medium">Ke Akun</label><select id="transfer-to" class="mt-1 block w-full p-2 border-gray-300 rounded-md" required></select></div>
                                <div class="mb-3"><label class="block text-sm font-medium">Jumlah</label><input type="number" id="transfer-jumlah" class="mt-1 block w-full p-2 border-gray-300 rounded-md" placeholder="500000" required></div>
                                <button type="submit" class="w-full bg-teal-600 text-white py-2 rounded-lg font-semibold hover:bg-teal-700">Transfer</button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Produk -->
                <div id="produk" class="tab-content hidden"><div class="card p-6"><div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">Manajemen Varian Produk</h3><button onclick="openModal('modal-produk')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 font-semibold"><i class="fas fa-plus mr-2"></i>Tambah Varian</button></div><div id="list-produk" class="overflow-x-auto"></div></div></div>
                
                <!-- Bahan Baku -->
                <div id="bahanBaku" class="tab-content hidden"><div class="card p-6"><div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">Manajemen Bahan Baku</h3><button onclick="openModal('modal-bahan')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 font-semibold"><i class="fas fa-plus mr-2"></i>Tambah Bahan</button></div><p class="text-sm text-gray-500 mb-4">Untuk menambah stok bahan yang sudah ada, gunakan form 'Catat Pembelian Bahan' di tab <button class="text-blue-600 font-semibold" onclick="changeTab('transaksi')">Input Transaksi</button>.</p><div id="list-bahan" class="overflow-x-auto"></div></div></div>

                <!-- Input Transaksi -->
                <div id="transaksi" class="tab-content hidden">
                     <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="card p-6"><h3 class="text-lg font-bold mb-4">Tambah Produksi</h3><form id="form-produksi"><div class="mb-3"><label class="block text-sm font-medium text-gray-700">Pilih Varian Produk</label><select id="produksi-produk-id" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm" required></select></div><div class="mb-3"><label class="block text-sm font-medium text-gray-700">Jumlah Botol</label><input type="number" id="produksi-jumlah" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm" placeholder="100" required></div><button type="submit" class="w-full bg-yellow-500 text-white py-2 rounded-lg font-semibold hover:bg-yellow-600">Tambah Stok</button></form></div>
                        <div class="card p-6"><h3 class="text-lg font-bold mb-4">Tambah Penjualan</h3><form id="form-penjualan"><div class="mb-3"><label class="block text-sm font-medium">Pilih Varian</label><select id="penjualan-produk-id" class="mt-1 block w-full p-2 border-gray-300 rounded-md" required></select></div><div class="mb-3"><label class="block text-sm font-medium">Jumlah Terjual</label><input type="number" id="penjualan-jumlah" class="mt-1 block w-full p-2 border-gray-300 rounded-md" placeholder="10" required></div><div class="mb-3"><label class="block text-sm font-medium">Masuk ke Akun</label><select id="penjualan-akun-id" class="mt-1 block w-full p-2 border-gray-300 rounded-md" required></select></div><div class="mb-3"><label class="block text-sm font-medium">Biaya Admin (Opsional)</label><input type="number" id="penjualan-admin-fee" class="mt-1 block w-full p-2 border-gray-300 rounded-md" placeholder="1000"></div><button type="submit" class="w-full bg-green-600 text-white py-2 rounded-lg font-semibold hover:bg-green-700">Catat Penjualan</button></form></div>
                        <div class="card p-6"><h3 class="text-lg font-bold mb-4">Catat Pembelian Bahan</h3><form id="form-pembelian-bahan"><div class="mb-3"><label class="block text-sm font-medium">Pilih Bahan</label><select id="pembelian-bahan-id" class="mt-1 block w-full p-2 border-gray-300 rounded-md" required></select></div><div class="mb-3"><label class="block text-sm font-medium">Dibayar Dari Akun</label><select id="pembelian-akun-id" class="mt-1 block w-full p-2 border-gray-300 rounded-md" required></select></div><div class="grid grid-cols-2 gap-3"><div><label class="block text-sm font-medium">Jumlah Dibeli</label><input type="number" id="pembelian-jumlah" class="mt-1 block w-full p-2 border-gray-300 rounded-md" placeholder="1000" required></div><div><label class="block text-sm font-medium">Total Harga</label><input type="number" id="pembelian-harga" class="mt-1 block w-full p-2 border-gray-300 rounded-md" placeholder="50000" required></div></div><button type="submit" class="mt-3 w-full bg-purple-600 text-white py-2 rounded-lg font-semibold hover:bg-purple-700">Catat Pembelian</button></form></div>
                        <div class="card p-6 md:col-span-2 lg:col-span-3"><h3 class="text-lg font-bold mb-4">Tambah Pengeluaran Operasional</h3><form id="form-pengeluaran" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end"><div class="md:col-span-2"><label class="block text-sm font-medium text-gray-700">Deskripsi</label><input type="text" id="pengeluaran-deskripsi" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm" placeholder="Cth: Biaya Iklan, Beli Lakban" required></div><div><label class="block text-sm font-medium text-gray-700">Dibayar Dari Akun</label><select id="pengeluaran-akun-id" class="mt-1 block w-full p-2 border-gray-300 rounded-md" required></select></div><div><label class="block text-sm font-medium text-gray-700">Jumlah</label><input type="number" id="pengeluaran-jumlah" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm" placeholder="50000" required></div><button type="submit" class="md:col-span-3 w-full bg-red-600 text-white py-2 rounded-lg font-semibold hover:bg-red-700">Catat Pengeluaran</button></form></div>
                     </div>
                </div>

                <!-- Analitik -->
                <div id="analitik" class="tab-content hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="card p-6">
                            <h3 class="text-xl font-bold mb-4">Analisis Profitabilitas Produk</h3>
                            <div id="profit-analysis" class="overflow-x-auto"></div>
                        </div>
                        <div class="card p-6">
                            <h3 class="text-xl font-bold mb-4">Produk Terlaris</h3>
                            <div id="best-sellers" class="space-y-4"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Laporan -->
                <div id="laporan" class="tab-content hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="card p-6"><div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">Riwayat Penjualan</h3><button onclick="exportToCSV('penjualan')" class="bg-gray-700 text-white px-3 py-1 rounded-lg text-sm hover:bg-gray-800"><i class="fas fa-file-csv mr-2"></i>Export</button></div><div id="list-penjualan" class="overflow-auto max-h-96"></div></div>
                        <div class="card p-6"><div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">Riwayat Pengeluaran</h3><button onclick="exportToCSV('pengeluaran')" class="bg-gray-700 text-white px-3 py-1 rounded-lg text-sm hover:bg-gray-800"><i class="fas fa-file-csv mr-2"></i>Export</button></div><div id="list-pengeluaran" class="overflow-auto max-h-96"></div></div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modals -->
    <div id="modal-akun-kas" class="modal-backdrop fixed inset-0 flex items-center justify-center hidden z-50"><div class="card p-6 w-full max-w-md"><h3 id="modal-akun-kas-title" class="text-xl font-bold mb-4">Tambah Akun Kas</h3><form id="form-akun-kas"><input type="hidden" id="akun-kas-id"><div class="mb-3"><label class="block text-sm font-medium">Nama Akun</label><input type="text" id="akun-kas-nama" class="mt-1 w-full p-2 border-gray-300 rounded-md" placeholder="Cth: Saldo Shopee" required></div><div class="mb-3"><label class="block text-sm font-medium">Saldo Awal</label><input type="number" id="akun-kas-saldo" class="mt-1 w-full p-2 border-gray-300 rounded-md" placeholder="0" required></div><div class="flex justify-end gap-3 mt-6"><button type="button" onclick="closeModal('modal-akun-kas')" class="bg-gray-200 px-4 py-2 rounded-lg font-semibold">Batal</button><button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold">Simpan</button></div></form></div></div>
    <div id="modal-produk" class="modal-backdrop fixed inset-0 flex items-center justify-center hidden z-50"><div class="card p-6 w-full max-w-lg"><h3 id="modal-produk-title" class="text-xl font-bold mb-4">Tambah Varian Baru</h3><form id="form-produk"><input type="hidden" id="produk-id"><div class="mb-3"><label class="block text-sm font-medium">Nama Varian</label><input type="text" id="produk-nama" class="mt-1 w-full p-2 border-gray-300 rounded-md" placeholder="Cth: Original" required></div><div class="mb-3"><label class="block text-sm font-medium">Harga Jual</label><input type="number" id="produk-harga" class="mt-1 w-full p-2 border-gray-300 rounded-md" placeholder="15000" required></div><div class="mb-4"><h4 class="text-md font-semibold mb-2">Resep Produk</h4><div id="recipe-builder" class="space-y-2"></div><button type="button" onclick="addRecipeIngredient()" class="text-sm text-blue-600 hover:text-blue-800 font-semibold mt-2"><i class="fas fa-plus mr-1"></i>Tambah Bahan</button></div><div class="mb-3 bg-blue-50 p-3 rounded-lg text-center"><label class="block text-sm font-medium">Estimasi HPP</label><p id="produk-hpp-display" class="font-bold text-lg text-blue-700">Rp 0</p></div><div class="flex justify-end gap-3 mt-6"><button type="button" onclick="closeModal('modal-produk')" class="bg-gray-200 px-4 py-2 rounded-lg font-semibold">Batal</button><button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold">Simpan</button></div></form></div></div>
    <div id="modal-bahan" class="modal-backdrop fixed inset-0 flex items-center justify-center hidden z-50"><div class="card p-6 w-full max-w-md"><h3 id="modal-bahan-title" class="text-xl font-bold mb-4">Tambah Bahan Baku</h3><form id="form-bahan"><input type="hidden" id="bahan-id"><div class="mb-3"><label class="block text-sm font-medium">Nama Bahan</label><input type="text" id="bahan-nama" class="mt-1 w-full p-2 border-gray-300 rounded-md" placeholder="Cth: Tawas" required></div><div class="mb-3"><label class="block text-sm font-medium">Satuan</label><input type="text" id="bahan-satuan" class="mt-1 w-full p-2 border-gray-300 rounded-md" placeholder="gr, ml, pcs" required></div><div class="mb-3"><label class="block text-sm font-medium">Peringatan Stok Rendah</label><input type="number" id="bahan-low-stock" class="mt-1 w-full p-2 border-gray-300 rounded-md" placeholder="100" required></div><div class="flex justify-end gap-3 mt-6"><button type="button" onclick="closeModal('modal-bahan')" class="bg-gray-200 px-4 py-2 rounded-lg font-semibold">Batal</button><button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold">Simpan</button></div></form></div></div>
    <div id="modal-settings" class="modal-backdrop fixed inset-0 flex items-center justify-center hidden z-50"><div class="card p-6 w-full max-w-md"><h3 class="text-xl font-bold mb-4">Pengaturan</h3><form id="form-settings"><div class="mb-4"><label class="block text-sm font-medium">Nama Bisnis</label><input type="text" id="settings-nama-bisnis" class="mt-1 w-full p-2 border-gray-300 rounded-md"></div><div class="flex justify-between gap-3 mt-6"><button type="button" onclick="openResetConfirmation()" class="bg-red-600 text-white px-4 py-2 rounded-lg font-semibold"><i class="fas fa-trash-alt mr-2"></i>Reset Semua Data</button><div><button type="button" onclick="closeModal('modal-settings')" class="bg-gray-200 px-4 py-2 rounded-lg font-semibold">Batal</button><button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold ml-2">Simpan</button></div></div></form></div></div>
    <div id="modal-confirm-reset" class="modal-backdrop fixed inset-0 flex items-center justify-center hidden z-50"><div class="card p-8 w-full max-w-md text-center"><i class="fas fa-exclamation-triangle text-5xl text-red-500 mb-4"></i><h3 class="text-xl font-bold mb-2">Anda Yakin?</h3><p class="text-gray-600 mb-6">Semua data bisnis Anda akan dihapus secara permanen dan tidak bisa dikembalikan. Lanjutkan?</p><div class="flex justify-center gap-4"><button type="button" onclick="closeModal('modal-confirm-reset')" class="bg-gray-200 px-6 py-2 rounded-lg font-semibold">Batal</button><button type="button" onclick="executeReset()" class="bg-red-600 text-white px-6 py-2 rounded-lg font-semibold">Ya, Hapus Semua</button></div></div></div>
    
    <script type="module">
        // Import Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            onAuthStateChanged, 
            signOut 
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc, 
            collection, 
            addDoc, 
            onSnapshot,
            query,
            deleteDoc,
            writeBatch,
            updateDoc
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        // --- PASTE FIREBASE CONFIG DI SINI ---
        const firebaseConfig = {
          apiKey: "AIzaSyAteCzZg75uy_2NudzlpiwtZdW779AeOjM",
          authDomain: "bisnisdeo-2bfa4.firebaseapp.com",
          projectId: "bisnisdeo-2bfa4",
          storageBucket: "bisnisdeo-2bfa4.appspot.com",
          messagingSenderId: "289299133175",
          appId: "1:289299133175:web:c0318dad3f28acb45899f2"
        };
        // ------------------------------------

        // Global state
        let appState = {};
        let unsubscribers = [];
        let userId;
        let auth, firestore_db;
        let dateFilter;

        const formatRupiah = (angka) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(angka);

        // --- AUTHENTICATION ---
        window.handleLogin = async (event) => {
            event.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                document.getElementById('auth-error').textContent = error.message;
            }
        };

        window.handleSignup = async (event) => {
            event.preventDefault();
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                // Create a user document to store their data
                await setDoc(doc(firestore_db, "users", userCredential.user.uid), {
                    settings: { businessName: 'Deo Business Suite' }
                });
            } catch (error) {
                document.getElementById('auth-error').textContent = error.message;
            }
        };

        window.handleLogout = async () => {
            await signOut(auth);
        };

        window.toggleAuthForm = (form) => {
            document.getElementById('login-form').classList.toggle('hidden', form === 'signup');
            document.getElementById('signup-form').classList.toggle('hidden', form === 'login');
            document.getElementById('auth-error').textContent = '';
        };

        // --- REALTIME LISTENERS ---
        function setupRealtimeListeners() {
            const collections = ['akunKas', 'transfers', 'produk', 'bahanBaku', 'pembelianBahan', 'produksi', 'penjualan', 'pengeluaran'];
            
            const settingsUnsub = onSnapshot(doc(firestore_db, "users", userId), (doc) => {
                appState.settings = doc.data()?.settings || { businessName: 'Deo Business Suite' };
                updateUI();
            });
            unsubscribers.push(settingsUnsub);

            collections.forEach(collName => {
                const q = query(collection(firestore_db, "users", userId, collName));
                const unsub = onSnapshot(q, (querySnapshot) => {
                    appState[collName] = [];
                    querySnapshot.forEach((doc) => {
                        appState[collName].push({ id: doc.id, ...doc.data() });
                    });
                    updateUI();
                });
                unsubscribers.push(unsub);
            });
        }

        // --- UI & UPDATES ---
        function updateUI(filterDates = null) {
            if (!userId) return;
            
            let filteredState = appState;
            if (filterDates && filterDates.length === 2) {
                const [start, end] = filterDates;
                end.setHours(23, 59, 59, 999);
                filteredState = {
                    ...appState,
                    penjualan: (appState.penjualan || []).filter(item => new Date(item.tanggal) >= start && new Date(item.tanggal) <= end),
                    pengeluaran: (appState.pengeluaran || []).filter(item => new Date(item.tanggal) >= start && new Date(item.tanggal) <= end)
                };
            }

            updateDashboard(filteredState);
            updateKeuanganTab();
            updateProdukList();
            updateBahanList();
            updateLaporan(filteredState);
            updateAnalitik(filteredState);
            populateDropdowns();
            updateSettings();
        }
        
        function updateSettings() {
            if(appState.settings) {
                document.getElementById('business-name-header').textContent = appState.settings.businessName;
                document.getElementById('settings-nama-bisnis').value = appState.settings.businessName;
            }
        }

        function updateDashboard(data) {
            const totalSaldo = (appState.akunKas || []).reduce((sum, acc) => sum + calculateAccountBalance(acc.id), 0);
            const totalPenjualan = (data.penjualan || []).reduce((sum, item) => sum + (item.jumlah * item.harga), 0);
            const totalKeuntungan = (data.penjualan || []).reduce((sum, item) => {
                const produk = (appState.produk || []).find(p => p.id === item.produkId);
                const hpp = produk ? produk.hpp : 0;
                return sum + (item.jumlah * (item.harga - hpp));
            }, 0);
            const totalPengeluaran = (data.pengeluaran || []).reduce((sum, item) => sum + item.jumlah, 0);

            document.getElementById('db-total-saldo').textContent = formatRupiah(totalSaldo);
            document.getElementById('db-total-penjualan').textContent = formatRupiah(totalPenjualan);
            document.getElementById('db-total-keuntungan').textContent = formatRupiah(totalKeuntungan);
            document.getElementById('db-total-pengeluaran').textContent = formatRupiah(totalPengeluaran);
            
            updateCharts(data);
        }

        function updateKeuanganTab() {
            const container = document.getElementById('list-akun-kas');
            const akunKas = appState.akunKas || [];
            container.innerHTML = akunKas.length === 0 ? `<p class="text-center text-gray-500 py-8">Belum ada akun kas. Silakan tambahkan.</p>` : 
            akunKas.map(acc => `
                <div class="card p-4 flex justify-between items-center">
                    <div>
                        <p class="font-bold text-lg">${acc.nama}</p>
                        <p class="text-sm text-gray-500">Saldo Saat Ini</p>
                    </div>
                    <p class="text-2xl font-semibold text-indigo-600">${formatRupiah(calculateAccountBalance(acc.id))}</p>
                </div>
            `).join('');
        }

        function updateCharts(data) {
            const penjualan = data.penjualan || [];
            const produk = appState.produk || [];

            // Sales Chart
            const salesCtx = document.getElementById('salesChart').getContext('2d');
            let labels, salesData;
            
            const hasDateFilter = dateFilter && dateFilter.selectedDates && dateFilter.selectedDates.length === 2;

            if (!hasDateFilter || (dateFilter.selectedDates[1] - dateFilter.selectedDates[0]) / (1000 * 60 * 60 * 24) <= 31) {
                const dateMap = new Map();
                penjualan.forEach(sale => {
                    const date = new Date(sale.tanggal).toLocaleDateString('id-ID');
                    dateMap.set(date, (dateMap.get(date) || 0) + (sale.jumlah * sale.harga));
                });
                labels = [...dateMap.keys()];
                salesData = [...dateMap.values()];
            } else {
                const monthMap = new Map();
                penjualan.forEach(sale => {
                    const month = new Date(sale.tanggal).toLocaleDateString('id-ID', {year: 'numeric', month: 'short'});
                    monthMap.set(month, (monthMap.get(month) || 0) + (sale.jumlah * sale.harga));
                });
                labels = [...monthMap.keys()];
                salesData = [...monthMap.values()];
            }

            if (window.salesChart instanceof Chart) {
                window.salesChart.destroy();
            }
            window.salesChart = new Chart(salesCtx, { type: 'line', data: { labels, datasets: [{ label: 'Penjualan', data: salesData, borderColor: '#2563eb', backgroundColor: '#dbeafe', tension: 0.3, fill: true }] }, options: { responsive: true, maintainAspectRatio: false } });

            // Variant Chart
            const variantCtx = document.getElementById('variantChart').getContext('2d');
            const variantLabels = produk.map(p => p.nama);
            const variantSalesData = produk.map(p => penjualan.filter(s => s.produkId === p.id).reduce((sum, s) => sum + s.jumlah, 0));
            const bgColors = ['#2563eb', '#16a34a', '#f59e0b', '#dc2626', '#9333ea', '#0d9488'];

            if (window.variantChart instanceof Chart) {
                window.variantChart.destroy();
            }
            window.variantChart = new Chart(variantCtx, { type: 'doughnut', data: { labels: variantLabels, datasets: [{ label: 'Botol Terjual', data: variantSalesData, backgroundColor: bgColors.slice(0, variantLabels.length), hoverOffset: 4 }] }, options: { responsive: true, maintainAspectRatio: false } });
        }

        function updateProdukList() {
            const container = document.getElementById('list-produk');
            const produk = appState.produk || [];
            container.innerHTML = produk.length === 0 ? `<p class="text-center text-gray-500 py-8">Belum ada varian produk.</p>` : `
                <table class="w-full text-sm text-left"><thead class="table-header text-xs text-gray-700 uppercase"><tr><th class="px-6 py-3">Nama Varian</th><th class="px-6 py-3">Harga Jual</th><th class="px-6 py-3">HPP</th><th class="px-6 py-3">Stok</th><th class="px-6 py-3">Aksi</th></tr></thead>
                <tbody>${produk.map(p => `
                    <tr class="bg-white border-b"><td class="px-6 py-4 font-bold">${p.nama}</td><td class="px-6 py-4">${formatRupiah(p.harga)}</td><td class="px-6 py-4">${formatRupiah(p.hpp)}</td><td class="px-6 py-4 font-semibold">${calculateStock(p.id)}</td>
                    <td class="px-6 py-4"><button onclick="editProduk('${p.id}')" class="text-blue-600 hover:text-blue-800 mr-3"><i class="fas fa-edit"></i></button><button onclick="deleteProduk('${p.id}')" class="text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button></td></tr>`).join('')}
                </tbody></table>`;
        }
        
        function updateBahanList() {
            const container = document.getElementById('list-bahan');
            const bahanBaku = appState.bahanBaku || [];
            container.innerHTML = bahanBaku.length === 0 ? `<p class="text-center text-gray-500 py-8">Belum ada bahan baku.</p>` : `
                <table class="w-full text-sm text-left"><thead class="table-header text-xs text-gray-700 uppercase"><tr><th class="px-6 py-3">Nama Bahan</th><th class="px-6 py-3">Stok</th><th class="px-6 py-3">Harga Rata-rata</th><th class="px-6 py-3">Aksi</th></tr></thead>
                <tbody>${bahanBaku.map(b => {
                    const stok = calculateBahanStock(b.id);
                    const isLow = stok <= b.lowStock;
                    return `<tr class="bg-white border-b ${isLow ? 'low-stock' : ''}"><td class="px-6 py-4 font-bold">${b.nama} ${isLow ? '<i class="fas fa-exclamation-triangle text-yellow-500 ml-2" title="Stok Rendah!"></i>' : ''}</td><td class="px-6 py-4 font-semibold">${stok.toLocaleString()} ${b.satuan}</td><td class="px-6 py-4">${formatRupiah(calculateBahanAvgPrice(b.id))} / ${b.satuan}</td>
                    <td class="px-6 py-4"><button onclick="editBahan('${b.id}')" class="text-blue-600 hover:text-blue-800 mr-3"><i class="fas fa-edit"></i></button><button onclick="deleteBahan('${b.id}')" class="text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button></td></tr>`
                }).join('')}</tbody></table>`;
        }
        
        function updateLaporan(data) {
            const penjualan = data.penjualan || [];
            const pengeluaran = data.pengeluaran || [];
            document.getElementById('list-penjualan').innerHTML = penjualan.length ? penjualan.slice().reverse().map(item => `<div class="p-2 border-b"><p class="font-semibold">${item.jumlah}x ${(appState.produk || []).find(p=>p.id===item.produkId)?.nama || 'N/A'}</p><p class="text-xs text-gray-500">${new Date(item.tanggal).toLocaleString('id-ID')} | Total: <span class="text-green-600 font-bold">${formatRupiah(item.jumlah * item.harga)}</span></p></div>`).join('') : '<p class="text-gray-500 text-center">Belum ada penjualan.</p>';
            document.getElementById('list-pengeluaran').innerHTML = pengeluaran.length ? pengeluaran.slice().reverse().map(item => `<div class="p-2 border-b"><p class="font-semibold">${item.deskripsi}</p><p class="text-xs text-gray-500">${new Date(item.tanggal).toLocaleString('id-ID')} | <span class="text-red-600 font-bold">${formatRupiah(item.jumlah)}</span></p></div>`).join('') : '<p class="text-gray-500 text-center">Belum ada pengeluaran.</p>';
        }

        function updateAnalitik(data) {
            const produk = appState.produk || [];
            const penjualan = data.penjualan || [];
            // Profitability
            const profitContainer = document.getElementById('profit-analysis');
            const profitData = produk.map(p => {
                const sales = penjualan.filter(s => s.produkId === p.id);
                const totalSold = sales.reduce((sum, s) => sum + s.jumlah, 0);
                const totalRevenue = sales.reduce((sum, s) => sum + (s.jumlah * s.harga), 0);
                const totalCost = totalSold * p.hpp;
                const netProfit = totalRevenue - totalCost;
                return { ...p, totalSold, totalRevenue, totalCost, netProfit };
            });
            profitContainer.innerHTML = profitData.length === 0 ? `<p class="text-center text-gray-500 py-8">Belum ada data.</p>` : `
                <table class="w-full text-sm text-left"><thead class="table-header text-xs text-gray-700 uppercase"><tr><th class="px-6 py-3">Produk</th><th class="px-6 py-3">Terjual</th><th class="px-6 py-3">Omzet</th><th class="px-6 py-3">Profit</th></tr></thead>
                <tbody>${profitData.map(p => `<tr class="bg-white border-b"><td class="px-6 py-4 font-bold">${p.nama}</td><td class="px-6 py-4">${p.totalSold}</td><td class="px-6 py-4">${formatRupiah(p.totalRevenue)}</td><td class="px-6 py-4 font-bold text-blue-600">${formatRupiah(p.netProfit)}</td></tr>`).join('')}</tbody></table>`;

            // Best Sellers
            const bestSellerContainer = document.getElementById('best-sellers');
            const sortedByQty = [...profitData].sort((a,b) => b.totalSold - a.totalSold).slice(0,3);
            const sortedByRevenue = [...profitData].sort((a,b) => b.totalRevenue - a.totalRevenue).slice(0,3);
            bestSellerContainer.innerHTML = `
                <div><h4 class="font-semibold">Terlaris (Jumlah)</h4><ol class="list-decimal list-inside mt-1">${sortedByQty.map(p => `<li>${p.nama} (${p.totalSold} terjual)</li>`).join('')}</ol></div>
                <div><h4 class="font-semibold">Terlaris (Omzet)</h4><ol class="list-decimal list-inside mt-1">${sortedByRevenue.map(p => `<li>${p.nama} (${formatRupiah(p.totalRevenue)})</li>`).join('')}</ol></div>`;
        }

        function populateDropdowns() {
            const kasOptions = (appState.akunKas || []).map(acc => `<option value="${acc.id}">${acc.nama}</option>`).join('');
            document.getElementById('penjualan-akun-id').innerHTML = kasOptions;
            document.getElementById('pembelian-akun-id').innerHTML = kasOptions;
            document.getElementById('pengeluaran-akun-id').innerHTML = kasOptions;
            document.getElementById('transfer-from').innerHTML = kasOptions;
            document.getElementById('transfer-to').innerHTML = kasOptions;

            document.getElementById('produksi-produk-id').innerHTML = (appState.produk || []).map(p => `<option value="${p.id}">${p.nama}</option>`).join('');
            document.getElementById('penjualan-produk-id').innerHTML = (appState.produk || []).map(p => `<option value="${p.id}">${p.nama}</option>`).join('');
            document.getElementById('pembelian-bahan-id').innerHTML = (appState.bahanBaku || []).map(b => `<option value="${b.id}">${b.nama}</option>`).join('');
        }

        // --- CALCULATIONS ---
        const calculateStock = (produkId) => (appState.produksi || []).filter(p => p.produkId === produkId).reduce((s, p) => s + p.jumlah, 0) - (appState.penjualan || []).filter(p => p.produkId === produkId).reduce((s, p) => s + p.jumlah, 0);
        const calculateBahanStock = (bahanId) => (appState.pembelianBahan || []).filter(p => p.bahanId === bahanId).reduce((s, p) => s + p.jumlah, 0) - (appState.produksi || []).flatMap(p => ((appState.produk || []).find(prod => prod.id === p.produkId)?.resep || []).filter(r => r.bahanId === bahanId).map(r => r.jumlah * p.jumlah)).reduce((s, u) => s + u, 0);
        const calculateBahanAvgPrice = (bahanId) => {
            const purchases = (appState.pembelianBahan || []).filter(p => p.bahanId === bahanId);
            if (purchases.length === 0) return 0;
            const totalCost = purchases.reduce((s, p) => s + p.harga, 0);
            const totalQty = purchases.reduce((s, p) => s + p.jumlah, 0);
            return totalCost / totalQty;
        };
        const calculateHPP = (resep) => resep.reduce((sum, item) => sum + (item.jumlah * calculateBahanAvgPrice(item.bahanId)), 0);
        const calculateAccountBalance = (accountId) => {
            let balance = 0;
            const account = (appState.akunKas || []).find(acc => acc.id === accountId);
            if (account) balance += account.saldoAwal;

            // Inflows
            (appState.penjualan || []).forEach(s => { if (s.akunId === accountId) balance += s.jumlah * s.harga - (s.adminFee || 0); });
            (appState.transfers || []).forEach(t => { if (t.toId === accountId) balance += t.jumlah; });
            
            // Outflows
            (appState.pengeluaran || []).forEach(e => { if (e.akunId === accountId) balance -= e.jumlah; });
            (appState.transfers || []).forEach(t => { if (t.fromId === accountId) balance -= t.jumlah; });
            
            return balance;
        };

        // --- MODAL & FORM LOGIC ---
        window.openModal = (modalId, id = null) => {
            const modal = document.getElementById(modalId);
            const form = modal.querySelector('form');
            if(form) form.reset();
            
            if (modalId === 'modal-akun-kas') {
                document.getElementById('akun-kas-id').value = '';
                document.getElementById('akun-kas-saldo').disabled = false;
                if (id) {
                    const acc = appState.akunKas.find(a => a.id === id);
                    document.getElementById('modal-akun-kas-title').textContent = 'Edit Akun Kas';
                    document.getElementById('akun-kas-id').value = acc.id;
                    document.getElementById('akun-kas-nama').value = acc.nama;
                    document.getElementById('akun-kas-saldo').value = acc.saldoAwal;
                    document.getElementById('akun-kas-saldo').disabled = true;
                } else {
                    document.getElementById('modal-akun-kas-title').textContent = 'Tambah Akun Kas';
                }
            } else if (modalId === 'modal-produk') {
                document.getElementById('produk-id').value = '';
                document.getElementById('recipe-builder').innerHTML = '';
                document.getElementById('produk-hpp-display').textContent = 'Rp 0';
                if (id) {
                    const produk = appState.produk.find(p => p.id === id);
                    document.getElementById('modal-produk-title').textContent = 'Edit Varian';
                    document.getElementById('produk-id').value = produk.id;
                    document.getElementById('produk-nama').value = produk.nama;
                    document.getElementById('produk-harga').value = produk.harga;
                    produk.resep.forEach(r => addRecipeIngredient(r.bahanId, r.jumlah));
                    updateHPPDisplay();
                } else {
                    document.getElementById('modal-produk-title').textContent = 'Tambah Varian Baru';
                    addRecipeIngredient();
                }
            } else if (modalId === 'modal-bahan') {
                document.getElementById('bahan-id').value = '';
                if (id) {
                    const bahan = appState.bahanBaku.find(b => b.id === id);
                    document.getElementById('modal-bahan-title').textContent = 'Edit Bahan Baku';
                    document.getElementById('bahan-id').value = bahan.id;
                    document.getElementById('bahan-nama').value = bahan.nama;
                    document.getElementById('bahan-satuan').value = bahan.satuan;
                    document.getElementById('bahan-low-stock').value = bahan.lowStock;
                } else {
                    document.getElementById('modal-bahan-title').textContent = 'Tambah Bahan Baku';
                }
            }
            modal.classList.remove('hidden');
        }

        window.closeModal = (modalId) => { document.getElementById(modalId).classList.add('hidden'); }
        
        window.addRecipeIngredient = (bahanId = '', jumlah = '') => {
            const container = document.getElementById('recipe-builder');
            const div = document.createElement('div');
            div.className = 'flex items-center gap-2';
            const options = (appState.bahanBaku || []).map(b => `<option value="${b.id}" ${b.id === bahanId ? 'selected' : ''}>${b.nama}</option>`).join('');
            div.innerHTML = `
                <select class="recipe-bahan w-1/2 p-2 border-gray-300 rounded-md">${options}</select>
                <input type="number" value="${jumlah}" class="recipe-jumlah w-1/3 p-2 border-gray-300 rounded-md" placeholder="Jumlah">
                <button type="button" onclick="this.parentElement.remove(); updateHPPDisplay()" class="text-red-500"><i class="fas fa-trash"></i></button>
            `;
            container.appendChild(div);
            div.querySelectorAll('select, input').forEach(el => el.addEventListener('change', updateHPPDisplay));
        }

        window.updateHPPDisplay = () => {
            const resep = [];
            document.querySelectorAll('#recipe-builder > div').forEach(row => {
                const bahanId = row.querySelector('.recipe-bahan').value;
                const jumlah = parseFloat(row.querySelector('.recipe-jumlah').value) || 0;
                if(bahanId && jumlah > 0) resep.push({ bahanId, jumlah });
            });
            document.getElementById('produk-hpp-display').textContent = formatRupiah(calculateHPP(resep));
        }
        
        // --- CRUD & Actions ---
        document.getElementById('form-akun-kas').addEventListener('submit', async function(e) {
            e.preventDefault();
            const id = document.getElementById('akun-kas-id').value;
            const accData = {
                nama: document.getElementById('akun-kas-nama').value,
                saldoAwal: parseInt(document.getElementById('akun-kas-saldo').value) || 0,
            };
            try {
                if (id) {
                    await updateDoc(doc(firestore_db, "users", userId, "akunKas", id), { nama: accData.nama });
                } else {
                    await addDoc(collection(firestore_db, "users", userId, "akunKas"), accData);
                }
                closeModal('modal-akun-kas');
            } catch (error) { console.error("Error saving account: ", error); alert("Gagal menyimpan akun."); }
        });

        document.getElementById('form-transfer').addEventListener('submit', async function(e) {
            e.preventDefault();
            const fromId = document.getElementById('transfer-from').value;
            const toId = document.getElementById('transfer-to').value;
            const jumlah = parseInt(document.getElementById('transfer-jumlah').value);

            if (!fromId || !toId) { alert("Harap pilih akun asal dan tujuan."); return; }
            if (isNaN(jumlah) || jumlah <= 0) { alert("Jumlah transfer tidak valid. Harap masukkan angka positif."); return; }
            if (fromId === toId) { alert("Akun asal dan tujuan tidak boleh sama."); return; }
            if (calculateAccountBalance(fromId) < jumlah) { alert("Saldo di akun asal tidak mencukupi."); return; }

            try {
                await addDoc(collection(firestore_db, "users", userId, "transfers"), {
                    fromId, toId, jumlah, tanggal: new Date().toISOString()
                });
                this.reset(); alert('Transfer dana berhasil dicatat.');
            } catch (error) { console.error("Error transfering funds: ", error); alert("Gagal mencatat transfer."); }
        });

        document.getElementById('form-produk').addEventListener('submit', async function(e) {
            e.preventDefault();
            const id = document.getElementById('produk-id').value;
            const resep = [];
            document.querySelectorAll('#recipe-builder > div').forEach(row => {
                const bahanId = row.querySelector('.recipe-bahan').value;
                const jumlah = parseFloat(row.querySelector('.recipe-jumlah').value) || 0;
                if(bahanId && jumlah > 0) resep.push({ bahanId, jumlah });
            });
            const produkData = {
                nama: document.getElementById('produk-nama').value,
                harga: parseInt(document.getElementById('produk-harga').value),
                hpp: calculateHPP(resep),
                resep: resep
            };
            try {
                if (id) {
                    await setDoc(doc(firestore_db, "users", userId, "produk", id), produkData);
                } else {
                    await addDoc(collection(firestore_db, "users", userId, "produk"), produkData);
                }
                closeModal('modal-produk');
            } catch (error) { console.error("Error saving product: ", error); alert("Gagal menyimpan produk."); }
        });

        document.getElementById('form-bahan').addEventListener('submit', async function(e) {
            e.preventDefault();
            const id = document.getElementById('bahan-id').value;
            const bahanData = {
                nama: document.getElementById('bahan-nama').value,
                satuan: document.getElementById('bahan-satuan').value,
                lowStock: parseInt(document.getElementById('bahan-low-stock').value)
            };
            try {
                if (id) {
                    await setDoc(doc(firestore_db, "users", userId, "bahanBaku", id), bahanData);
                    alert('Bahan baku berhasil diperbarui.');
                } else {
                    await addDoc(collection(firestore_db, "users", userId, "bahanBaku"), bahanData);
                    alert(`Sukses! Bahan baku "${bahanData.nama}" berhasil disimpan.`);
                }
                closeModal('modal-bahan');
            } catch (error) { console.error("Error saving material: ", error); alert("Gagal menyimpan bahan baku."); }
        });

        document.getElementById('form-settings').addEventListener('submit', async function(e) {
            e.preventDefault();
            const newName = document.getElementById('settings-nama-bisnis').value;
            try {
                await setDoc(doc(firestore_db, "users", userId), { settings: { businessName: newName } });
                closeModal('modal-settings');
                alert('Pengaturan disimpan!');
            } catch (error) { console.error("Error saving settings: ", error); alert("Gagal menyimpan pengaturan."); }
        });

        document.getElementById('form-produksi').addEventListener('submit', async function(e) {
            e.preventDefault();
            const produkId = document.getElementById('produksi-produk-id').value;
            const jumlah = parseInt(document.getElementById('produksi-jumlah').value);
            const produk = (appState.produk || []).find(p => p.id === produkId);
            if (!produk) { alert("Produk tidak ditemukan!"); return; }
            
            for (const item of produk.resep) {
                if (calculateBahanStock(item.bahanId) < item.jumlah * jumlah) {
                    const bahan = (appState.bahanBaku || []).find(b => b.id === item.bahanId);
                    alert(`Gagal! Stok bahan baku "${bahan.nama}" tidak mencukupi.`);
                    return;
                }
            }
            try {
                await addDoc(collection(firestore_db, "users", userId, "produksi"), { produkId, jumlah, tanggal: new Date().toISOString() });
                this.reset(); alert('Produksi berhasil dicatat & stok bahan baku dikurangi!');
            } catch (error) { console.error("Error saving production: ", error); alert("Gagal mencatat produksi."); }
        });

        document.getElementById('form-penjualan').addEventListener('submit', async function(e) {
            e.preventDefault();
            const produkId = document.getElementById('penjualan-produk-id').value;
            const jumlah = parseInt(document.getElementById('penjualan-jumlah').value);
            const produk = (appState.produk || []).find(p => p.id === produkId);
            const akunId = document.getElementById('penjualan-akun-id').value;
            const adminFee = parseInt(document.getElementById('penjualan-admin-fee').value) || 0;

            if (calculateStock(produkId) < jumlah) { alert(`Gagal! Stok ${produk.nama} tidak mencukupi.`); return; }
            
            try {
                const batch = writeBatch(firestore_db);
                const penjualanRef = doc(collection(firestore_db, "users", userId, "penjualan"));
                batch.set(penjualanRef, { produkId, jumlah, harga: produk.harga, tanggal: new Date().toISOString(), akunId, adminFee });

                if (adminFee > 0) {
                    const pengeluaranRef = doc(collection(firestore_db, "users", userId, "pengeluaran"));
                    batch.set(pengeluaranRef, { deskripsi: `Biaya Admin Penjualan ${produk.nama}`, jumlah: adminFee, tanggal: new Date().toISOString(), akunId: null });
                }
                await batch.commit();
                this.reset(); alert('Penjualan berhasil dicatat!');
            } catch (error) { console.error("Error saving sale: ", error); alert("Gagal mencatat penjualan."); }
        });

        document.getElementById('form-pembelian-bahan').addEventListener('submit', async function(e) {
            e.preventDefault();
            const akunId = document.getElementById('pembelian-akun-id').value;
            const harga = parseInt(document.getElementById('pembelian-harga').value);

            if (calculateAccountBalance(akunId) < harga) { alert('Saldo di akun yang dipilih tidak mencukupi.'); return; }

            try {
                const batch = writeBatch(firestore_db);
                const pembelianRef = doc(collection(firestore_db, "users", userId, "pembelianBahan"));
                batch.set(pembelianRef, { bahanId: document.getElementById('pembelian-bahan-id').value, jumlah: parseInt(document.getElementById('pembelian-jumlah').value), harga, tanggal: new Date().toISOString() });
                
                const pengeluaranRef = doc(collection(firestore_db, "users", userId, "pengeluaran"));
                const bahanNama = (appState.bahanBaku || []).find(b=>b.id === document.getElementById('pembelian-bahan-id').value).nama;
                batch.set(pengeluaranRef, { deskripsi: `Beli bahan: ${bahanNama}`, jumlah: harga, tanggal: new Date().toISOString(), akunId });
                
                await batch.commit();
                this.reset(); alert('Pembelian bahan baku berhasil dicatat!');
            } catch (error) { console.error("Error saving purchase: ", error); alert("Gagal mencatat pembelian."); }
        });

        document.getElementById('form-pengeluaran').addEventListener('submit', async function(e) {
            e.preventDefault();
            const akunId = document.getElementById('pengeluaran-akun-id').value;
            const jumlah = parseInt(document.getElementById('pengeluaran-jumlah').value);

            if (calculateAccountBalance(akunId) < jumlah) { alert('Saldo di akun yang dipilih tidak mencukupi.'); return; }
            
            try {
                await addDoc(collection(firestore_db, "users", userId, "pengeluaran"), { deskripsi: document.getElementById('pengeluaran-deskripsi').value, jumlah, tanggal: new Date().toISOString(), akunId });
                this.reset(); alert('Pengeluaran berhasil dicatat!');
            } catch (error) { console.error("Error saving expense: ", error); alert("Gagal mencatat pengeluaran."); }
        });
        
        window.editProduk = (id) => openModal('modal-produk', id);
        window.deleteProduk = async (id) => { 
            if (confirm('Yakin hapus produk ini? Riwayat penjualan dan produksi terkait akan tetap ada.')) {
                try {
                    await deleteDoc(doc(firestore_db, "users", userId, "produk", id));
                } catch (error) { console.error("Error deleting product: ", error); alert("Gagal menghapus produk."); }
            } 
        };
        
        window.editBahan = (id) => openModal('modal-bahan', id);
        
        window.deleteBahan = async (id) => {
            try {
                const productsUsingMaterial = (appState.produk || []).filter(p => Array.isArray(p.resep) && p.resep.some(r => r && r.bahanId === id));
                if (productsUsingMaterial.length > 0) {
                    const productNames = productsUsingMaterial.map(p => p.nama || "Tanpa Nama").join(', ');
                    alert(`Gagal menghapus! Bahan ini masih digunakan dalam resep produk: ${productNames}.\n\nHarap hapus bahan ini dari resep tersebut terlebih dahulu atau hapus produknya.`);
                    return;
                }
                if (confirm('Yakin ingin menghapus bahan ini? Semua riwayat pembelian bahan ini juga akan dihapus secara permanen.')) {
                    const batch = writeBatch(firestore_db);
                    batch.delete(doc(firestore_db, "users", userId, "bahanBaku", id));
                    (appState.pembelianBahan || []).filter(p => p.bahanId === id).forEach(p => {
                        batch.delete(doc(firestore_db, "users", userId, "pembelianBahan", p.id));
                    });
                    await batch.commit();
                    alert('Bahan baku dan riwayat pembeliannya berhasil dihapus.');
                }
            } catch (error) {
                console.error("Error during deleteBahan:", error);
                alert("Terjadi kesalahan yang tidak terduga saat mencoba menghapus bahan. Silakan coba segarkan halaman.");
            }
        }

        // --- UTILITIES ---
        function exportToCSV(type) {
            let data, headers, filename;
            if (type === 'penjualan') {
                headers = ['ID', 'Tanggal', 'ID Produk', 'Nama Produk', 'Jumlah', 'Harga Satuan', 'Total', 'Biaya Admin', 'Akun Kas'];
                data = (appState.penjualan || []).map(item => [item.id, new Date(item.tanggal).toLocaleString('id-ID'), item.produkId, (appState.produk || []).find(p=>p.id===item.produkId)?.nama || 'N/A', item.jumlah, item.harga, item.jumlah * item.harga, item.adminFee || 0, (appState.akunKas || []).find(a=>a.id===item.akunId)?.nama || 'N/A']);
                filename = 'laporan_penjualan.csv';
            } else {
                headers = ['ID', 'Tanggal', 'Deskripsi', 'Jumlah', 'Akun Kas'];
                data = (appState.pengeluaran || []).map(item => [item.id, new Date(item.tanggal).toLocaleString('id-ID'), item.deskripsi, item.jumlah, (appState.akunKas || []).find(a=>a.id===item.akunId)?.nama || 'N/A']);
                filename = 'laporan_pengeluaran.csv';
            }
            const csvContent = "data:text/csv;charset=utf-8," + [headers.join(','), ...data.map(e => e.join(','))].join('\n');
            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csvContent));
            link.setAttribute("download", filename);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        window.changeTab = (tabId) => {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            document.getElementById(tabId).classList.remove('hidden');
            document.querySelectorAll('.tab-button').forEach(button => button.classList.remove('active'));
            document.querySelector(`button[onclick="changeTab('${tabId}')"]`).classList.add('active');
        }

        // --- INITIALIZATION ---
        window.addEventListener('load', () => {
            // Check if Firebase config is provided
            if (!firebaseConfig.apiKey || firebaseConfig.apiKey.includes("...")) {
                document.getElementById('loader').classList.add('hidden');
                document.getElementById('config-error').classList.remove('hidden');
                return; // Stop the app from running
            }

            // Initialize Firebase
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            firestore_db = getFirestore(app);

            onAuthStateChanged(auth, user => {
                const loader = document.getElementById('loader');
                const authContainer = document.getElementById('auth-container');
                const appContainer = document.getElementById('app-container');
                
                unsubscribers.forEach(unsub => unsub());
                unsubscribers = [];

                if (user) {
                    userId = user.uid;
                    document.getElementById('user-email-display').textContent = user.email;
                    
                    authContainer.classList.add('hidden');
                    appContainer.classList.remove('hidden');
                    loader.classList.add('hidden');
                    
                    setupRealtimeListeners();
                } else {
                    authContainer.classList.remove('hidden');
                    appContainer.classList.add('hidden');
                    loader.classList.add('hidden');
                    userId = null;
                }
            });

            dateFilter = flatpickr("#date-filter", {
                mode: "range",
                dateFormat: "d M Y",
                onChange: function(selectedDates, dateStr, instance) {
                    if (selectedDates.length === 2) {
                        updateUI(selectedDates);
                    }
                },
                onClose: function(selectedDates, dateStr, instance) {
                    if (selectedDates.length < 2) {
                        instance.clear();
                        updateUI();
                    }
                }
            });
        });
    </script>
</body>
</html>
